<!-- static/admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ARCHITECH Admin Panel</title>
  <style>
    body { background:#111; color:#eee; font-family:monospace; padding:20px }
    h1,h2 { color:#0ff }
    table { width:100%; border-collapse:collapse; margin-bottom:1em }
    th,td { border:1px solid #333; padding:8px; text-align:center }
    th { background:#222 }
    input,button { padding:6px; margin:4px; background:#222; color:#eee; border:1px solid #444 }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  </style>
</head>
<body>
  <h1>ðŸ”’ ARCHITECH Admin Panel</h1>
  <div class="flex">
    <label>JWT: <input id="jwt" size="60" /></label>
    <button onclick="loadUsers()">Users</button>
    <button onclick="loadSessions()">Sessions</button>
    <button onclick="loadKeys()">API Keys</button>
  </div>

  <h2>Create New User</h2>
  <form id="createForm" onsubmit="createUser();return false;">
    <input id="u_name" placeholder="Username"/>&nbsp;
    <input id="u_pw"   placeholder="Password"/>&nbsp;
    <label>Admin<input type="checkbox" id="u_admin"/></label>&nbsp;
    <input id="u_sid"  placeholder="Twilio SID"/>&nbsp;
    <input id="u_tok"  placeholder="Twilio Token"/>&nbsp;
    <button type="submit">Create</button>
  </form>

  <h2>Users</h2>
  <table id="users"><thead><tr>
    <th>ID</th><th>User</th><th>Admin</th><th>Active</th><th>SID</th><th>Token</th><th>Actions</th>
  </tr></thead><tbody></tbody></table>

  <h2>Sessions</h2>
  <table id="sessions"><thead><tr>
    <th>ID</th><th>User</th><th>IP</th><th>Device</th><th>OS</th><th>Agent</th><th>When</th>
  </tr></thead><tbody></tbody></table>

  <h2>API Keys</h2>
  <form id="createKeyForm" onsubmit="createKey();return false;">
    <input id="k_user"   placeholder="User ID" size="4"/>
    <input id="k_scopes" placeholder="Scopes, comma-sep"/>
    <input id="k_quota"  placeholder="Quota(leave blank=âˆž)" size="6"/>
    <button type="submit">Generate Key</button>
  </form>
  <table id="keys"><thead><tr>
    <th>ID</th><th>User</th><th>Key</th><th>Scopes</th>
    <th>Used</th><th>Quota</th><th>Created</th><th>Revoked</th><th>Actions</th>
  </tr></thead><tbody></tbody></table>

  <script>
    const API = window.location.origin;
    function getJWT(){ return document.getElementById('jwt').value; }

    // USERS
    async function loadUsers(){
      const res = await fetch(API+"/admin/users", {headers:{"Authorization":"Bearer "+getJWT()}});
      const data = await res.json();
      const tb = document.querySelector("#users tbody");
      tb.innerHTML="";
      data.forEach(u=>{
        tb.innerHTML+=`
          <tr>
            <td>${u.id}</td><td>${u.username}</td><td>${u.is_admin}</td>
            <td>${u.active}</td><td>${u.twilio_sid||''}</td>
            <td>${u.twilio_token||''}</td>
            <td><button onclick="deleteUser(${u.id})">Delete</button></td>
          </tr>`;
      });
    }
    async function createUser(){
      const body = {
        username: document.getElementById("u_name").value,
        password: document.getElementById("u_pw").value,
        is_admin: document.getElementById("u_admin").checked,
        twilio_sid: document.getElementById("u_sid").value,
        twilio_token: document.getElementById("u_tok").value
      };
      await fetch(API+"/admin/users", {
        method:"POST",
        headers:{
          "Authorization":"Bearer "+getJWT(),
          "Content-Type":"application/json"
        },
        body: JSON.stringify(body)
      });
      loadUsers();
    }
    async function deleteUser(id){
      if(!confirm("Delete user #"+id+"?")) return;
      await fetch(API+`/admin/users/${id}`, {
        method:"DELETE", headers:{"Authorization":"Bearer "+getJWT()}
      });
      loadUsers();
    }

    // SESSIONS
    async function loadSessions(){
      const res = await fetch(API+"/admin/sessions", {headers:{"Authorization":"Bearer "+getJWT()}});
      const data = await res.json();
      const tb = document.querySelector("#sessions tbody");
      tb.innerHTML="";
      data.forEach(s=>{
        tb.innerHTML+=`
          <tr>
            <td>${s.id}</td><td>${s.user_id}</td><td>${s.ip_address}</td>
            <td>${s.device_model||''}</td><td>${s.os_info||''}</td>
            <td>${s.user_agent||''}</td>
            <td>${new Date(s.timestamp).toLocaleString()}</td>
          </tr>`;
      });
    }

    // API KEYS
    async function loadKeys(){
      const res = await fetch(API+"/admin/keys", {headers:{"Authorization":"Bearer "+getJWT()}});
      const data = await res.json();
      const tb = document.querySelector("#keys tbody");
      tb.innerHTML="";
      data.forEach(k=>{
        tb.innerHTML+=`
          <tr>
            <td>${k.id}</td><td>${k.user_id}</td>
            <td>${k.key.slice(0,6)}â€¢â€¢â€¢</td>
            <td>${k.scopes.join(",")}</td>
            <td>${k.usage_count}</td>
            <td>${k.usage_quota===null?"âˆž":k.usage_quota}</td>
            <td>${new Date(k.created_at).toLocaleString()}</td>
            <td>${k.revoked}</td>
            <td><button onclick="revokeKey('${k.key}')">Revoke</button></td>
          </tr>`;
      });
    }
    async function createKey(){
      const body = {
        user_id:   parseInt(document.getElementById("k_user").value),
        scopes:    document.getElementById("k_scopes").value.split(","),
        usage_quota: document.getElementById("k_quota").value
                      ? parseInt(document.getElementById("k_quota").value)
                      : null
      };
      await fetch(API+"/admin/keys", {
        method:"POST",
        headers:{
          "Authorization":"Bearer "+getJWT(),
          "Content-Type":"application/json"
        },
        body: JSON.stringify(body)
      });
      loadKeys();
    }
    async function revokeKey(key){
      if(!confirm("Revoke key "+key.slice(0,6)+"â€¦?")) return;
      await fetch(API+`/admin/keys/${key}`, {
        method:"DELETE",
        headers:{"Authorization":"Bearer "+getJWT()}
      });
      loadKeys();
    }

    // initialize
    window.onload = ()=>{ loadUsers(); loadSessions(); loadKeys(); };
  </script>
</body>
</html>
